<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fanqs - Fuck Apple Music, Netease Cloud Music QQ Music and Spotify.</title>
	<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.js"></script>
	<script src="https://cdn.bootcdn.net/ajax/libs/socket.io/4.5.2/socket.io.min.js"></script>
	<script src="https://cdn.bootcdn.net/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
	<link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.2.0/css/all.css" rel="stylesheet">
	<!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.1/css/bootstrap.min.css" rel="stylesheet"> -->
	<link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.1/css/bootstrap-grid.min.css" rel="stylesheet">
	<link rel="stylesheet" href="style.css">
</head>

<body>

	<h1>fanqs</h1>
	<!-- 最大分栏 -->
	<div class="row">
		<!-- 播放控制 -->
		<div class="player-section col">
			<audio id="audio" controls="controls" style="display: none;">
				<source src="" id='song' type="audio/mpeg" />
			</audio>
			<p class="music-title" id="music-title"></p>
			<p class="artist" id="artist"></p>
			<span class="audio-time" id="currentTime">0</span>
			<div class="timeline inline" id="timeline">-</div>
			<span class="audio-time" id="audioTime">0</span>
			<br>
			<button class="btn green" id="prev">[prev]</button>
			<button class="btn green" id="play">[play]</button>
			<button class="btn green" id="next">[next]</button>
			<button class="btn blue" id="random">[random]</button>
			<br>
			<button class="btn yellow" id="volume-down">[v-]</button>
			<div class="volume col inline" id="volume">[50%]</div>
			<button class="btn yellow" id="volume-up">[v+]</button>
			<button class="btn blue" id="init">[refresh]</button>
			<br>
			<h2>playlist</h2>
			<ul class="song-list" id="playlist"></ul>
		</div>
		<div class="text-section col">
			<h1>Songs</h1>
			<ul class="song-list" id="song-list">

			</ul>
		</div>
		<div class="lib-section col">
			<h1>Albums</h1>
			<ul class="album-list" id="album-list">

			</ul>
		</div>
	</div>


	<script>
		const demo = document.getElementById("demo");
		const audio = document.getElementById("audio");
		const play = document.getElementById("play");
		const prev = document.getElementById("prev");
		const next = document.getElementById("next");
		const volumeUp = document.getElementById("volume-up");
		const volumeDown = document.getElementById("volume-down");
		const volume = document.getElementById("volume");
		const audioTime = document.getElementById("audioTime");
		const currentTime = document.getElementById("currentTime");
		const title = document.getElementById("music-title");
		const artist = document.getElementById("artist");
		const timeline = document.getElementById("timeline");
		const init = document.getElementById("init");
		const songList = document.getElementById("song-list");
		const albumList = document.getElementById("album-list");
		const playlist = document.getElementById("playlist");


		// 播放模式
		const PLAY_MODE = {
			ORDER: 0,
			LOOP: 1,
			REPEAT: 2,
			RANDOM: 3
		};

		let play_mode = PLAY_MODE.LOOP;

		// 播放列表
		let currentPlaylist = [];
		let playingIndex = 0;

		window.onload = () => {
			getSongs();
		}

		function getSongs() {
			fetch(`/api/songs?album=`, {
				method: 'GET', // or 'PUT'
				headers: {
					'Content-Type': 'application/json'
				}
			})
				.then(response => response.json())
				.then(data => {
					console.log(data.songs);
					let albumArr = [];
					let albumHTML = `<li class="album"><a href="javascript:;" class="blue album" onClick="albumOnclick('')">[all]</a></li>`;
					// songs = data.songs.slice(0);
					// 创建 list
					let listHTML = `<li class="song"><a href="javascript:;" class="blue song" onClick="playAllOnclick('')">[play all]</a></li>`;
					for (let li of data.songs) {
						// 按 album 分类
						if (!albumArr.includes(li.album)) {
							albumArr.push(li.album);
							albumHTML += `<li class="album"><a href="javascript:;" class="green album" onClick="albumOnclick('${li.album}')">${li.album}</a></li>`;
						}
						listHTML += `<li class="song"><a href="javascript:;" class="add yellow" onClick="addOnclick('${li._id}')">[+]</a><a href="javascript:;" class="green song" onClick="songOnclick('${li._id}')">${li.title} - ${li.artist}</a></li>`;
					}
					songList.innerHTML = listHTML;
					albumList.innerHTML = albumHTML;
				}).catch((error) => {
					console.error('Error:', error);
				});
		}


		function setPlay() {
			play.innerHTML = "[pause]";
		}

		function setPause() {
			play.innerHTML = "[play]";
		}

		function transTime(time) {
			var duration = parseInt(time);
			var minute = parseInt(duration / 60);
			var sec = duration % 60 + '';
			var isM0 = ':';
			if (minute == 0) {
				minute = '00';
			} else if (minute < 10) {
				minute = '0' + minute;
			}
			if (sec.length == 1) {
				sec = '0' + sec;
			}
			return minute + isM0 + sec
		}

		//更新进度条
		function updateProgress() {
			var value = Math.round((Math.floor(audio.currentTime) / Math.floor(audio.duration)) * 100, 0);
			// TODO: 进度条动画
			// $('.pgs-play').css('width', value * 0.907 + '%');
			currentTime.innerHTML = transTime(audio.currentTime);
		}


		audio.volume = 0.5;

		const socket = io("http://localhost:8964");

		audio.addEventListener("loadedmetadata", () => {
			console.log(audio.duration);
			audioTime.innerHTML = transTime(audio.duration);
		});

		audio.addEventListener('timeupdate', updateProgress, false);

		audio.addEventListener('playing', () => {
			setPlay();
		}, false);

		audio.addEventListener('pause', () => {
			// if (play_mode !== PLAY_MODE.REPEAT && playingIndex == currentPlaylist.length - 1) {
			setPause();
			// }

		}, false);

		audio.addEventListener('ended', () => {
			switch (play_mode) {
				case PLAY_MODE.REPEAT:
					audio.play();
					break;
				case PLAY_MODE.LOOP:
					if (playingIndex === currentPlaylist.length - 1) {
						playingIndex = 0;
					} else {
						playingIndex += 1;
					}
					audio.src = 'http://localhost:8964/api/song?' + `id=${currentPlaylist[playingIndex]}`;
					audio.load();
					getInfo(currentPlaylist[playingIndex]);
					audio.play();
					break;
				default:
					// 默认 repeat
					audio.play();
					break;
			}
		}, false);

		// song list button
		function songOnclick(id) {
			console.log(id);
			currentPlaylist.splice(0, currentPlaylist.length);
			playlist.innerHTML = "";
			currentPlaylist.push(id);
			playingIndex = 0;
			audio.src = 'http://localhost:8964/api/song?' + `id=${currentPlaylist[playingIndex]}`;
			console.log(audio.src);
			getInfo(id);
			audio.load();
			// setPlay();
			audio.play();
		}

		function albumOnclick(album) {
			// console.log(album);
			fetch(`/api/songs?album=${album}`, {
				method: 'GET', // or 'PUT'
				headers: {
					'Content-Type': 'application/json'
				}
			})
				.then(response => response.json())
				.then(data => {
					// console.log(data.songs);
					let listHTML = `<li class="song"><a href="javascript:;" class="blue song" onClick="playAllOnclick('${album}')">[play all]</a></li>`;
					for (let li of data.songs) {
						listHTML += `<li class="song"><a href="javascript:;" class="add yellow" onClick="addOnclick('${li._id}')">[+]</a><a href="javascript:;" class="green song" onClick="songOnclick('${li._id}')">${li.title} - ${li.artist}</a></li>`;
					}
					songList.innerHTML = listHTML;
				}).catch((error) => {
					console.error('Error:', error);
				});
		}

		function playAllOnclick(album) {
			fetch(`/api/songs?album=${album}`, {
				method: 'GET', // or 'PUT'
				headers: {
					'Content-Type': 'application/json'
				}
			})
				.then(response => response.json())
				.then(data => {

					currentPlaylist.splice(0, currentPlaylist.length);
					playlist.innerHTML = "";
					for (let li of data.songs) {
						currentPlaylist.push(li._id);
						playlist.innerHTML += `<li class="song">${li.title}</li>`;
					}
					playingIndex = 0;
					audio.src = 'http://localhost:8964/api/song?' + `id=${currentPlaylist[playingIndex]}`;
					audio.load();
					getInfo(currentPlaylist[playingIndex]);
					audio.play();
				}).catch((error) => {
					console.error('Error:', error);
				});

		}

		// TODO: 添加到播放列表
		// function addOnclick(id) {
		// 	console.log("add:", id);
		// 	currentPlaylist.push(id);
		// 	playlist.innerHTML += `<li class="song">${id}</li>`;
		// 	// TODO: show list
		// }

		function getInfo(id) {
			fetch(`/api/info?id=${id}`, {
				method: 'GET', // or 'PUT'
				headers: {
					'Content-Type': 'application/json',
				}
			})
				.then(response => response.json())
				.then(data => {
					console.log(data);
					title.innerHTML = data.title;
					artist.innerHTML = data.artist;
				})
				.catch((error) => {
					console.error('Error:', error);
				});
		}



		// play controll
		play.onclick = () => {
			if (audio.paused) {
				audio.play();
				// setPlay();
			} else {
				audio.pause();
				// setPause();
			}
		};

		next.onclick = () => {
			if (playingIndex === currentPlaylist.length - 1) {
				playingIndex = 0;
			} else {
				playingIndex += 1;
			}
			audio.src = 'http://localhost:8964/api/song?' + `id=${currentPlaylist[playingIndex]}`;
			console.log(audio.src);
			getInfo(currentPlaylist[playingIndex]);
			audio.load();
			// setPlay();
			audio.play();
		}
		
		prev.onclick = () => {
			if (playingIndex === 0) {
				playingIndex = currentPlaylist.length - 1;
			} else {
				playingIndex -= 1;
			}
			audio.src = 'http://localhost:8964/api/song?' + `id=${currentPlaylist[playingIndex]}`;
			console.log(audio.src);
			getInfo(currentPlaylist[playingIndex]);
			audio.load();
			// setPlay();
			audio.play();
		}


		init.onclick = () => {
			fetch('/api/db/init', {
				method: 'GET',
				headers: {
					'Content-Type': 'application/json'
					// 'Content-Type': 'application/x-www-form-urlencoded',
				}
			}).then((data) => {
				console.log(data);
			})
		}

		// volume controll
		volumeUp.onclick = () => {
			if (audio.volume < 1) {
				if (audio.volume + 0.05 > 1) {
					audio.volume = 1;
				} else {
					audio.volume += 0.05;
				}
				volume.innerHTML = `[${(audio.volume * 100).toFixed(0)}%]`;
			}
		};
		volumeDown.onclick = () => {
			if (audio.volume > 0) {
				if (audio.volume - 0.05 < 0) {
					audio.volume = 0;
				} else {
					audio.volume -= 0.05;
				}

				console.log(audio.volume);
				volume.innerHTML = `[${(audio.volume * 100).toFixed(0)}%]`;
			}
			// let volumeValue = parseInt(volume.text().replace(/[^\d]/g, " "));
			// if (volumeValue > 0) {
			// 	volumeValue -= 5;
			// 	//TODO: 音量减
			// 	volume.innerHTML = `[${volumeValue}%]`;
			// }
		};




	</script>
</body>

</html>